<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pax im Pub</title>
  <style>
    /* einfache dunkle Oberfläche */
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0b0b0c;color:#fff}
    .wrap{max-width:600px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 16px}
    .card{background:#141416;border:1px solid #2a2a2e;border-radius:12px;padding:20px}
    .count{font-size:64px;line-height:1.1;font-weight:700;letter-spacing:1px;text-align:center;margin:10px 0 0}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:16px}
    button{padding:12px 16px;border-radius:10px;border:1px solid #2a2a2e;background:#1c1c21;color:#fff;cursor:pointer;font-size:16px}
    button:hover{background:#22222a}
    .muted{opacity:.7;font-size:14px;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Überschrift -->
    <h1>Pax im Pub</h1>

    <div class="card">
      <!-- Hier wird die aktuelle Zahl angezeigt -->
      <div id="value" class="count">–</div>

      <!-- Test-Buttons, nur sichtbar wenn man lokal ein Token gespeichert hat -->
      <div class="grid" id="testButtons" style="display:none">
        <button onclick="send('in')">+1 rein (Test)</button>
        <button onclick="send('out')">-1 raus (Test)</button>
      </div>

      <div class="muted">Zähler wird täglich um 08:00 (Europa/Berlin) automatisch auf 0 gesetzt.</div>
    </div>
  </div>

  <script>
    // Diese Funktion holt alle 2 Sekunden den aktuellen Stand vom Server
    async function fetchCount() {
      try {
        const r = await fetch('/api/count', { cache: 'no-store' });
        const j = await r.json();
        document.getElementById('value').textContent = j.count ?? 0;
      } catch {
        document.getElementById('value').textContent = 'Err';
      }
    }

    // Diese Funktion sendet +1 oder -1 an den Server (z. B. bei Test)
    async function send(direction){
      try{
        await fetch('/api/webhook', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-Webhook-Token': window.localStorage.getItem('WEBHOOK_TOKEN') || ''
          },
          body: JSON.stringify({ direction, count: 1 })
        });
        await fetchCount(); // danach neu laden
      }catch{}
    }

    // Start: aktuellen Wert laden und alle 2s aktualisieren
    fetchCount();
    setInterval(fetchCount, 2000);

    // Wenn man im Browser ein Token gespeichert hat, Test-Buttons anzeigen
    if (window.localStorage.getItem('WEBHOOK_TOKEN')) {
      document.getElementById('testButtons').style.display = 'grid';
    }
  </script>
</body>
</html>
